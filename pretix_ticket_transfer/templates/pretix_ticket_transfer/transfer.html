{% extends "pretixpresale/event/base.html" %}
{% load i18n %}
{% load eventurl %}
{% load money %}
{% load static %}
{% load rich_text %}
{% block title %}{% trans "Ticket transfer" %}{% endblock %}
{% block content %}

<h2>
    {% blocktrans trimmed with code=order.code %}
        Ticket transfer for order: {{ code }}
    {% endblocktrans %}
</h2>

<form class="form-horizontal" action="{% eventurl event "plugins:pretix_ticket_transfer:generate" secret=order.secret order=order.code %}" method="post">

{% csrf_token %}

{% if step3 %}
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">{% trans "Confirm ticket transfer" %}</h3>
    </div>
    <div class="panel-body">

        {% if message %}{{message}}{% endif %}

        <input type="hidden" name="email" value="{{ email }}" />
        <input type="hidden" name="bank_account_holder" value="{{ bank_info.account_holder }}" />
        <input type="hidden" name="bank_iban" value="{{ bank_info.iban }}" />
        <input type="hidden" name="bank_bic" value="{{ bank_info.bic }}" />
        <input type="hidden" name="bank_name" value="{{ bank_info.bank_name }}" />
        <input type="hidden" name="step2" value="1" />
        <input type="hidden" name="step3" value="1" />
        {% for pid in pids %}
        <input type="hidden" name="pos[]" value="{{ pid }}" />
        {% endfor %}

        <h4>{% trans "Recipient" %}:</h4>
        <section><p>{{ email }}</p></section>

        <h4>{% trans "Refund Bank Details" %}:</h4>
        <section>
            <p><strong>{% trans "Account Holder" %}:</strong> {{ bank_info.account_holder }}</p>
            <p><strong>{% trans "IBAN" %}:</strong> {{ bank_info.iban }}</p>
            {% if bank_info.bic %}<p><strong>{% trans "BIC" %}:</strong> {{ bank_info.bic }}</p>{% endif %}
            {% if bank_info.bank_name %}<p><strong>{% trans "Bank Name" %}:</strong> {{ bank_info.bank_name }}</p>{% endif %}
        </section>

        <h4>{% trans "Tickets" %}:</h4>
        <div role="table" class="cart ttcart" aria-label="Selected tickets">
            {% for i in pos %}
                <input type="hidden" name="pos[]" value="{{i.id}}" />
                <div role="rowgroup">
                    <div role="row" class="row cart-row">
                        <div role="cell" class="product">
                            {{i.item.name}}
                            {% if i.variation %}{{i.variation}}{% endif %}
                            {% if i.attendee_name_cached %} - {{i.attendee_name_cached}}{% endif %}
                        </div>
                        <div role="cell" class="totalprice price">{{i.price_with_addons |money:event.currency }}</div>
                    </div>
                </div>
            {% endfor %}
            <div role="rowgroup">
                <div role="row" class="row cart-row total">
                    <div role="cell" class="product">{% trans "Total worth of ticket transfer" %}</div>
                    <div role="cell" class="totalprice price">{{totalprice |money:event.currency }}</div>
                </div>
            </div>
        </div>

        <div class="row checkout-button-row">
            <div class="col-md-4">
                <button name="step2" value="1" type="submit" class="btn btn-block btn-primary">{% trans "Go back" %}</button>
            </div>
            <div class="col-md-4 col-md-offset-4">
                <button name="confirm" value="1" type="submit" class="btn btn-block btn-primary">{% trans "Confirm ticket transfer" %}</button>
            </div>
        </div>

    </div>
</div>

{% elif step2 %}
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">
            {% if event.settings.pretix_ticket_transfer_step2_title %}
                {{ event.settings.pretix_ticket_transfer_step2_title|rich_text }}
            {% else %}
                {% trans "Bank Details for Refund" %}
            {% endif %}
        </h3>
    </div>
    <div class="panel-body">
        <p>
            {% if event.settings.pretix_ticket_transfer_bank_details_intro %}
                {{ event.settings.pretix_ticket_transfer_bank_details_intro|rich_text }}
            {% else %}
                {% trans "Please enter your bank details so we can process your refund once the new owner has paid for the tickets." %}
            {% endif %}
        </p>

        <input type="hidden" name="email" value="{{ email }}" />
        <input type="hidden" name="email_repeat" value="{{ email }}" />
        <input type="hidden" name="step2" value="1" />
        {% for pid in pids %}
        <input type="hidden" name="pos[]" value="{{ pid }}" />
        {% endfor %}

        <div class="form-group required">
            <label class="col-md-3 control-label" for="bank_account_holder">
                <i class="sr-only label-required">, {% trans "required" %}</i>
                {% trans "Account Holder" %}
            </label>
            <div class="col-md-9">
                <input id="bank_account_holder" class="form-control" type="text" name="bank_account_holder" 
                    value="{% if bank_info.account_holder %}{{ bank_info.account_holder }}{% endif %}"
                    required aria-describedby="help-for-bank_account_holder" />
                <p class="help-block" id="help-for-bank_account_holder">
                    {% trans "Name of the account holder" %}
                </p>
            </div>
        </div>

        <div class="form-group required">
            <label class="col-md-3 control-label" for="bank_iban">
                <i class="sr-only label-required">, {% trans "required" %}</i>
                {% trans "IBAN" %}
            </label>
            <div class="col-md-9">
                <input id="bank_iban" class="form-control" type="text" name="bank_iban" 
                    value="{% if bank_info.iban %}{{ bank_info.iban }}{% endif %}"
                    required aria-describedby="help-for-bank_iban" 
                    pattern="[A-Z]{2}[0-9]{2}[A-Z0-9]{4}[0-9]{7}([A-Z0-9]?){0,16}" />
                <p class="help-block" id="help-for-bank_iban">
                    {% trans "International Bank Account Number" %}
                </p>
            </div>
        </div>

        <div class="form-group">
            <label class="col-md-3 control-label" for="bank_bic">
                {% trans "BIC" %}
            </label>
            <div class="col-md-9">
                <input id="bank_bic" class="form-control" type="text" name="bank_bic" 
                    value="{% if bank_info.bic %}{{ bank_info.bic }}{% endif %}"
                    aria-describedby="help-for-bank_bic" />
                <p class="help-block" id="help-for-bank_bic">
                    {% trans "Bank Identifier Code (optional)" %}
                </p>
            </div>
        </div>

        <div class="form-group">
            <label class="col-md-3 control-label" for="bank_name">
                {% trans "Bank Name" %}
            </label>
            <div class="col-md-9">
                <input id="bank_name" class="form-control" type="text" name="bank_name" 
                    value="{% if bank_info.bank_name %}{{ bank_info.bank_name }}{% endif %}"
                    aria-describedby="help-for-bank_name" />
                <p class="help-block" id="help-for-bank_name">
                    {% trans "Name of your bank (optional)" %}
                </p>
            </div>
        </div>

        <div class="row checkout-button-row">
            <div class="col-md-4">
                <button name="step2" value="" type="submit" class="btn btn-block btn-primary">{% trans "Go back" %}</button>
            </div>
            <div class="col-md-4 col-md-offset-4">
                <button name="step3" value="1" type="submit" class="btn btn-block btn-primary">{% trans "Continue" %}</button>
            </div>
        </div>

    </div>
</div>

{% else %}

{% if message %}
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">{{ title }}</h3>
    </div>
    <div class="panel-body">
        {{message}}
    </div>
</div>
{% endif %}

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">{% trans "Select tickets" %}</h3>
    </div>
    <div class="panel-body">
        {% for i in orderpositions %}
            <div class="checkbox">
                <label for="select_pos_{{i.id}}">
                    <input id="select_pos_{{i.id}}" type="checkbox" name="pos[]" value="{{i.id}}" {% if i in pos %}checked{% endif %}/>
                    #{{i.positionid}} {{i.item.name}}
                    {% if i.variation %}{{i.variation}}{% endif %}
                    {% if i.attendee_name_cached %} - {{i.attendee_name_cached}}{% endif %}
                </label>
            </div>
        {% endfor %}
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">{% trans "Choose recipient" %}</h3>
    </div>
    <div class="panel-body">

        <div class="form-group required">
            <label class="col-md-3 control-label" for="tt-email-0">
                <i class="sr-only label-required">, {% trans "required" %}</i>
                {% trans "Email" %}
            </label>
            <div class="col-md-9">
                <input id="tt-email-0" class="form-control" type="email" name="email" value="{{email}}"
                    autocomplete="section-contact email"
                    title="{% trans "Please enter the email address of the person who should recieve the tickets." %}" required
                    aria-describedby="help-for-tt-email-0" />
                <p class="help-block" id="help-for-tt-email-0">
                    {% trans "Please enter the email address of the person who should recieve the tickets." %}
                </p>
            </div>
        </div>

        <div class="form-group required">
            <label class="col-md-3 control-label" for="tt-email-1">
                <i class="sr-only label-required">, {% trans "required" %}</i>
                {% trans "Email (repeated)" %}
            </label>
            <div class="col-md-9">
                <input id="tt-email-0" class="form-control" type="email" name="email_repeat" value="{{email_repeat}}"
                    autocomplete="section-contact email"
                    title="{% trans "Please enter the same email address again to make sure you typed it correctly." %}" required 
                    aria-describedby="help-for-tt-email-1" />
                <p class="help-block" id="help-for-tt-email-1">
                    {% trans "Please enter the same email address again to make sure you typed it correctly." %}
                </p>
            </div>
        </div>

        <div class="row checkout-button-row">
            <div class="col-md-4">
                <a class="btn btn-block btn-primary" href="{% eventurl event "presale:event.order" secret=order.secret order=order.code %}">
                    {% trans "Cancel" %}
                </a>
            </div>
            <div class="col-md-4 col-md-offset-4">
                <button name="step2" value="1" type="submit" class="btn btn-block btn-primary">{% trans "Continue" %}</button>
            </div>
        </div>

    </div>
</div>

{% endif %}

</form>
{% endblock %}

